<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaChat Client</title>
    <script src="peerjs.min.js"></script>
    <script src="jq321.js"></script>
    <script src="jqm150.js"></script>
    <link rel="stylesheet" href="ui.css">
    <!-- <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #serverConnection, #loginRegister, #chat {
            padding: 20px;
        }
        #messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        #messageBar {
            display: flex;
        }
        input[type="text"], input[type="password"] {
            flex: 1;
            padding: 5px;
            margin-right: 5px;
        }
        button {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style> -->
</head>

<body class="ui-mobile ui-pagecontainer ui-mobile-viewport ui-overlay-a">

    <div class="ui-bar ui-bar-b">
        <h3>NovaChat</h3>
    </div>
    <div role="main" class="ui-content">
        <div id="app">
            <div id="serverConnection">
                <h2>Connect to Server</h2>
                <label for="serverId">Server ID</label>
                <input type="text" id="serverId" placeholder="Enter server ID">
                <button class="ui-button ui-corner-all ui-widget" onclick="connectToServer()">Connect</button>
            </div>
            <div id="loginRegister" style="display: none;">
                <h2>Login or Register</h2>
                <input type="text" id="username" placeholder="Username">
                <input type="password" id="password" placeholder="Password">
                <button onclick="login()">Login</button>
                <button onclick="register()">Register</button>
            </div>
            <div id="chat" style="display: none;">
                <h2>NovaChat</h2>
                <div id="messages"></div>
                <div id="messageBar">
                    <input type="text" id="messageInput" placeholder="Type your message...">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
        <script>
            let peer;
            let conn;
            let currentUser = null;

            function connectToServer() {
                const serverId = document.getElementById('serverId').value;
                peer = new Peer();
                $.mobile.loading("show", {
                    text: "Initialising Connection Module (PeerJS)",
                    textVisible: true,
                    theme: "b",
                    html: ""
                });
                peer.on('open', (id) => {
                    console.log('Connected to PeerJS with client ID:', id);
                    $.mobile.loading("show", {
                        text: "Connecting to Server",
                        textVisible: true,
                        theme: "b",
                        html: ""
                    });
                    conn = peer.connect(serverId);
                    conn.on('open', () => {
                        $.mobile.loading("hide")
                        console.log('Connected to server:', serverId);
                        document.getElementById('serverConnection').style.display = 'none';
                        document.getElementById('loginRegister').style.display = 'block';
                    });
                    conn.on('data', handleIncomingData);
                });

                peer.on('error', (err) => {
                    $.mobile.loading("hide")
                    console.error('PeerJS error:', err);
                    alert('Failed to connect. Please check the server ID and try again.');
                });
            }

            function login() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                conn.send({ type: 'login', username, password });
            }

            function register() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                conn.send({ type: 'register', username, password });
            }

            function handleIncomingData(data) {
                switch (data.type) {
                    case 'chat':
                        addMessage(data.sender, data.message);
                        break;
                    case 'login':
                        handleLoginResponse(data);
                        break;
                    case 'register':
                        handleRegisterResponse(data);
                        break;
                }
            }

            function handleLoginResponse(data) {
                if (data.success) {
                    currentUser = document.getElementById('username').value;
                    document.getElementById('loginRegister').style.display = 'none';
                    document.getElementById('chat').style.display = 'block';
                    loadMessages();
                } else {
                    alert(data.message || 'Login failed');
                }
            }

            function handleRegisterResponse(data) {
                if (data.success) {
                    alert('Registration successful. Please login.');
                } else {
                    alert(data.message || 'Registration failed');
                }
            }

            function sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value;
                if (message.trim() === '') return;
                conn.send({ type: 'chat', message: { name: currentUser, text: message } });
                // addMessage(currentUser, message);
                messageInput.value = '';
            }

            function addMessage(sender, message) {
                const messagesDiv = document.getElementById('messages');
                const messageElement = document.createElement('p');
                messageElement.textContent = `${sender}: ${message}`;
                messagesDiv.appendChild(messageElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;

                // Store message in localStorage
                const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
                messages.push({ sender, message, timestamp: new Date().toISOString() });
                localStorage.setItem('chatMessages', JSON.stringify(messages));

                // Show notification
                showNotification(sender, message);
            }

            function loadMessages() {
                const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                messages.forEach(msg => {
                    const messageElement = document.createElement('p');
                    messageElement.textContent = `${msg.sender}: ${msg.message}`;
                    messagesDiv.appendChild(messageElement);
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            function showNotification(sender, message) {
                if (Notification.permission === 'granted' && sender !== currentUser) {
                    new Notification('New message from ' + sender, { body: message });
                }
            }

            // Request notification permission
            if ('Notification' in window) {
                Notification.requestPermission();
            }

            // Event listener for Enter key in message input
            document.getElementById('messageInput').addEventListener('keypress', function (event) {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });
        </script>
    </div>

</body>

</html>